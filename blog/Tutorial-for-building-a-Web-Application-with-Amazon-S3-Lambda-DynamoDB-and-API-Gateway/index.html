<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta name="author" content="Connor Leech"><title>Tutorial for building a Web Application with Amazon S3, Lambda, DynamoDB and API Gateway</title><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="cleartype" content="on"><meta name="MobileOptimized" content="320"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="description" content="In this tutorial we build out a ride sharing application utilizing jQuery, Node.js and AWS Serverless architecture for fun and profit."><meta name="keywords" content="laravel, aws, javascript, php, developer, software engineer, web development, software, node.js, serverless, lambda, san francisco, bay area, east bay, vue, vuejs, vue.js, vue 2, laravel 5, amazon web services"><meta name="zipcode" content="94501"><meta name="city" content="Alameda"><meta name="state" content="California"><meta name="country" content="United States"><meta name="language" content="EN"><meta property="og:site_name" content="Connor Leech Blog | Javascript and Laravel tutorials"><meta property="og:description" content="Get notified about the latest trends in web development, career growth and cloud infrastructure. I send emails about twice a month covering tutorials in Javascript, Laravel and Cloud"><meta property="og:image" content="http://i0.kym-cdn.com/photos/images/original/001/018/899/936.jpg"><meta property="og:title" content="Tutorial for building a Web Application with Amazon S3, Lambda, DynamoDB and API Gateway"><meta property="og:description" content="In this tutorial we build out a ride sharing application utilizing jQuery, Node.js and AWS Serverless architecture for fun and profit."><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70809574-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-70809574-1');
</script><!-- Favicon--><link rel="shortcut icon" type="image/png" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><!-- Vendor Fonts--><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/bower_components/animate.css/animate.min.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Yantramanav" rel="stylesheet"><!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries--><!-- WARNING: Respond.js doesn't work if you view the page via file://--><!--if lt IE 9script(src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js')
script(src='https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js')
--><link rel="alternate" href="/atom.xml" title="config.title" type="application/rss2.xml"><link rel="stylesheet" href="/css/main.css"></head><body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top" class="post"><!-- Nav--><nav role="navigation" class="navbar navbar-custom navbar-fixed-top"><div class="container"><div class="navbar-header"><a href="/" class="navbar-brand"><img src="/images/employbl_logo.svg" style="height:100px; width:100px;"></a><button type="button" data-toggle="collapse" data-target=".navbar-main-collapse" class="navbar-toggle"><i class="fa fa-bars"></i></button></div><div class="collapse navbar-collapse navbar-left navbar-main-collapse"></div><div class="collapse navbar-collapse navbar-right navbar-main-collapse"><ul class="nav navbar-nav"><li><a href="/blog" class="page-scroll">Blog ðŸ”¨</a></li><li><a href="/#about" class="page-scroll">About âš¡</a></li><li><a href="https://leanpub.com/badass-web-development-with-laravel-5" target="_blank" class="page-scroll">Book ðŸ“–</a></li></ul></div></div></nav><main id="content"><div id="archive" class="container"><div class="row"> <div class="col-sm-2 col-md-2"><h3>Categories</h3><a href="/blog"><p>All</p></a><a href="/categories/Career"><p>Career</p></a><a href="/categories/Programming"><p>Programming</p></a><a href="/categories/Javascript"><p>Javascript</p></a><a href="/categories/Laravel"><p>Laravel</p></a><a href="/categories/Cloud"><p>Cloud</p></a><a href="/categories/PHP"><p>PHP</p></a></div><div class="col-xs-12 col-md-8"><article class="post"><div class="row"><div class="col-md-10 col-md-offset-1"><h1 class="post-title">Tutorial for building a Web Application with Amazon S3, Lambda, DynamoDB and API Gateway</h1></div></div><div class="row"><div class="post-meta"><h5><span>Connor Leech</span><span class="date"> - Aug 28, 2017&ensp;in<span class="post-categories">&ensp;<a href="/categories/Cloud/" class="post-category">Cloud</a></span></span></h5><a target="_blank" href="http://twitter.com/intent/tweet?status=Tutorial for building a Web Application with Amazon S3, Lambda, DynamoDB and API Gateway by @Connor11528+http://connorleech.info/blog/Tutorial-for-building-a-Web-Application-with-Amazon-S3-Lambda-DynamoDB-and-API-Gateway/" class="btn btn-primary social-share twitter"><i class="fa fa-twitter fa-2x"><span class="hidden-xs"></span></i></a><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://connorleech.info/blog/Tutorial-for-building-a-Web-Application-with-Amazon-S3-Lambda-DynamoDB-and-API-Gateway/&amp;title=Tutorial for building a Web Application with Amazon S3, Lambda, DynamoDB and API Gateway&amp;source=connorleech.info" class="btn btn-primary social-share linkedin"><i class="fa fa-linkedin fa-2x"><span class="hidden-xs"></span></i></a></div></div><div class="post-body"><p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/wildrydes-complete-architecture.png" alt=""></p>
<p>I recently attended Serverless Day at the AWS Loft in downtown San Francisco. During the workshop section we built a serverless web application for requesting Unicorns to come pick us up. The AWS team provided excellent documentation <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication" target="_blank" rel="external">on Github</a> and <a href="https://www.linkedin.com/in/rahul-sareen-1b2bb86/" target="_blank" rel="external">Rahul Sareen</a> gave a one of the best presentations I have heard at a tech event overviewing Serverless application architecture. (Slides for that presentation are <a href="https://www.slideshare.net/AmazonWebServices/getting-started-with-aws-lambda-and-serverless-computing-79032206" target="_blank" rel="external">available here</a>).</p>
<p>In the workshop portion we created and deployed a website that utilized S3 for hosting, DynamoDB for a database, API Gateway for RESTful endpoints and Lambda functions as our backend server processing.</p>
<p>This tutorial covers my notes from building out the application and using some of these services for the first time on Serverless Day 2017. More detailed notes for following along are available <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication" target="_blank" rel="external">on the github</a> and the Wild Rydes demo application is live at <a href="http://www.wildrydes.com/" target="_blank" rel="external">http://www.wildrydes.com/</a>.</p>
<h2 id="Step-0-About-WildRydes"><a href="#Step-0-About-WildRydes" class="headerlink" title="Step 0: About WildRydes"></a>Step 0: About WildRydes</h2><p>The application we are going to create in this tutorial is called Wild Rydes. The application is a fictional service for ordering unicorns to come pick us up. Users can login to the application and request unicorns from their current location. The application then dispatches a unicorn to pick up the user.</p>
<p><img src="http://www.wildrydes.com/images/wr-home-top.jpg" alt=""></p>
<p>Without further ado, letâ€™s get started.</p>
<h2 id="Step-1-Identity-Access-Management"><a href="#Step-1-Identity-Access-Management" class="headerlink" title="Step 1: Identity Access Management"></a>Step 1: Identity Access Management</h2><p>As with most AWS tutorials, the first step is to create an IAM user that will create and provision our AWS resources. I have a user set up that has AdminAccess. It is considered best practice to login using such an user rather than logging into and managing your AWS resources using your root account credentials. If you have no idea what Iâ€™m talking about I suggest checking out the <a href="https://acloud.guru/course/aws-certified-developer-associate" target="_blank" rel="external">A Cloud Guru course</a> for passing the AWS Certified Developer - Associate exam. Chapter 3 provides easy to follow video instructions on setting up users for your AWS account.</p>
<p>If you are not so inclined, the AWS team also provides <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/3_ServerlessBackend" target="_blank" rel="external">detailed instructions</a> for creating an IAM user with the specific permissions (<code>AWSLambdaBasicExecutionRole</code>) to write to DynamoDB and CloudWatch. If you associate your Lambda function with a user that has admin access your Lambda function will be able to access any service.</p>
<p>You also want to make sure that when you install the <a href="https://github.com/aws/aws-cli" target="_blank" rel="external">AWS CLI</a> it is associated with the user you created. When creating a new IAM user you get one chance to download the key-value pair for that user. In the command line type <code>aws configure</code> and you can set your public and secret API keys for the CLI.</p>
<p>Managing user access is important for account security and provisioning access to our AWS resources. We ran into some errors getting things set up and all of the errors were related to IAM so make sure you have permissions to do what you are trying to do! (<em>pro tip</em>: <code>aws configure</code> helps)</p>
<h2 id="Step-2-Static-Website-on-Simple-Storage-Service-S3"><a href="#Step-2-Static-Website-on-Simple-Storage-Service-S3" class="headerlink" title="Step 2: Static Website on Simple Storage Service (S3)"></a>Step 2: Static Website on Simple Storage Service (S3)</h2><p>In this section of the tutorial we are going to create an S3 bucket to host the static portion of our Wild Rydes application. Static Website means HTML, CSS, Javascript and Image files. S3 provides <strong>object storage</strong> meaning we cannot run an operating system on it but we can host a website.</p>
<p>The first step is to create an S3 bucket and enable the static web hosting option for that bucket. The AWS team provides details instructions on how to do this <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/1_StaticWebHosting" target="_blank" rel="external">here</a>.</p>
<p>When static website hosting is enabled for an S3 bucket, the contents of the <strong>index.html</strong> file within that bucket will be publicly accessible to the internet following this URL structure: <code>http://BUCKET_NAME.s3-website-REGION.amazonaws.com/</code> where BUCKET_NAME is the globally unique name you gave your bucket and REGION is the region you created the bucket in (such as <code>us-east-1</code> for Virginia or <code>us-west-2</code> for Oregon).</p>
<p>Since this tutorial focuses on AWS infrastructure instead of static website coding, we copy the files for Wild Rydes from the AWS team. This code is open source and <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/1_StaticWebHosting/website" target="_blank" rel="external">available here</a></p>
<p>The command to copy the contents of their bucket into our bucket is as follows:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">aws</span> <span class="built_in">s3</span> sync <span class="built_in">s3</span>://wildrydes-us-east-<span class="number">1</span>/WebApplication/<span class="number">1</span>_StaticWebHosting/website <span class="built_in">s3</span>://YOUR_BUCKET_NAME --region YOUR_BUCKET_REGION</div></pre></td></tr></table></figure>
<p>After running this command all of our static files should appear in our S3 bucket when we refresh the page showing our bucket contents. If you are having issues syncing the files across buckets using the command line make sure you are logged in as the same IAM user that created the bucket or that the keys/permissions line up.</p>
<p>Of the new contents of our bucket, the main file to take note of is <strong>js/config.js</strong>. Weâ€™ll be editing this file with values from <a href="https://aws.amazon.com/cognito/" target="_blank" rel="external">Cognito</a> and <a href="https://aws.amazon.com/api-gateway/" target="_blank" rel="external">API Gateway</a>. </p>
<p>Finally, we want to make sure that our bucket is publicly accessible to the internet. For this we add a bucket policy as outlined below:</p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/update-bucket-policy.png" alt=""></p>
<p>JSON schema for our S3 bucket policy:
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</div><div class="line">    <span class="attr">"Statement"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</div><div class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</div><div class="line">            <span class="attr">"Action"</span>: <span class="string">"s3:GetObject"</span>,</div><div class="line">            <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::YOUR_BUCKET_NAME/*"</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>My bucket is called <strong>wildrydes-082317</strong> and created within <strong>us-west-2</strong> (Oregon) so my static website files are publicly accessible here: <a href="http://wildrydes-082317.s3-website-us-west-2.amazonaws.com/" target="_blank" rel="external">http://wildrydes-082317.s3-website-us-west-2.amazonaws.com/</a></p>
<h2 id="Step-3-User-Management-with-Cognito"><a href="#Step-3-User-Management-with-Cognito" class="headerlink" title="Step 3: User Management with Cognito"></a>Step 3: User Management with Cognito</h2><p>In the <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/2_UserManagement" target="_blank" rel="external">next step</a> we will configure a Cognito user pool to manage users. This hooks up the functionality for users to create 
 accounts, verify their email addresses and sign in to the Wild Rydes site.</p>
<p>Following the above instructions, the first step is to create a Cognito user pool using the AWS console. Cognito user pools provide out of the box functionality for federated identity providers (such as Google and Facebook login), password recovery and user authorization security in the cloud. You can learn more about user pools <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html" target="_blank" rel="external">here</a>. </p>
<p>When we create our Cognito user pool and create an app client. App clients have permission to call unauthenticated APIs (such as register, login and forgot passowrd). Take note of your <strong>Pool Id</strong> and the <strong>App client id</strong> (featured below) as we will insert these values into <strong>js/config.js</strong></p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/pool-id.png" alt=""></p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/client-id.png" alt=""></p>
<p>Head into your S3 bucket, download and modify <strong>js/config.js</strong> with your appropriate values from Cognito. Reupload the file back to your S3 bucket. We will have to do this one more time to populate the <code>invokeUrl</code> with a value from API gateway. Populating the <code>cognito</code> javascript object in that file connects our static web application to Amazonâ€™s cloud authentication services. For a detailed jQuery implementation of user management on the client side, view the files <a href="https://github.com/awslabs/aws-serverless-workshops/blob/master/WebApplication/1_StaticWebHosting/website/js/cognito-auth.js" target="_blank" rel="external">here</a>.</p>
<p>Once we have updated our Cognito object within the config file, head over to the register page at <code>YOUR_S3_URL/register.html</code>. In my case the full url is: <code>http://wildrydes-082317.s3-website-us-west-2.amazonaws.com/register.html</code>.</p>
<p>Sign up and create an account. Use your real email address! Cognito sends a test email with a link to verify your account. When you check your email after creating your account you will have a verification code, such as: <code>211658</code>.</p>
<p>Go to <code>YOUR_S3_URL/verify.html</code> and enter your email address and confirmation code.</p>
<p>Go to signin page and signin with your new account: <code>/signin.html</code></p>
<p>This flow could definitely be optimized. There is no client side routing implemented and we still have .html appended to all of our routes. Nevertheless, you can update this code with The Javascript Framework Of Your Choice. The backend process for registering users to Cognito will stay the same as we are using the Cognito client side JS SDK. The email verification is an option enabled by default that can easily be switched off. </p>
<p>You can customize the verification message by navigating to your Cognito User Pool by clicking <strong>Message Customizations</strong> on the left navigation panel. </p>
<p>It is worth noting here that we could use other authentication services such as <a href="https://auth0.com/" target="_blank" rel="external">Auth0</a> (they have an awesome developer blog). This is an Amazon provided tutorial though so we are using all AWS functionality.</p>
<p>When we successfully create a user, verify and sign in we will get to this screen:</p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/successful-login.png" alt=""></p>
<h2 id="Step-4-Set-up-Serverless-Backend"><a href="#Step-4-Set-up-Serverless-Backend" class="headerlink" title="Step 4: Set up Serverless Backend"></a>Step 4: Set up Serverless Backend</h2><p>In this step weâ€™ll implement a Lambda function that will be invoked each time a signed in user requests a unicorn. Lambda functions are the core functionality qualifying apps as Serverless. Lambda functions are a managed service provided by Amazon. We provide the code for the Lambda function and only pay for the time it takes that function to execute. We do not have to deal with provisioning EC2 instances or Elastic Load Balancing (typical operations functions for cloud applications). The primary advantage of this approach is that is is far cheaper than dedicated cloud hosting. It can also allow us to focus more on writing code and less on operations. Serverless and Lambda functions are a new Amazon service and new paradigm for web applications so there will be a learning curve but have the potential to save us massive time and money down the road.</p>
<p>The full steps for setting up the serverless backend are <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/3_ServerlessBackend" target="_blank" rel="external">available here</a>.</p>
<p>Before we even get to setting up Lambda functions and a serverless application we are going to create a DynamoDB database. <a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="external">DynamoDB</a> is Amazonâ€™s managed NoSQL database. We are going to use DynamoDB to store information about the ride request when a user requests a Unicorn.</p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/ddb-create-table.png" alt=""></p>
<p>When we create the database note the ARN. It will look something like this: </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Amazon<span class="built_in"> Resource </span>Name (ARN)	arn:aws:dynamodb:us-west-2:XXXXXXXXXXXX:table/Rides</div></pre></td></tr></table></figure>
<p>Now that the database is created weâ€™re going to an IAM role for the Lambda function. Every Lambda function must have an IAM role associated with it. The IAM role defines what AWS services the Lambda function is permitted to interact with. In this case we are going to go with the <code>AWSLambdaBasicExecutionRole</code>. This basic role covers the functionality we need for the Wild Rydes application â€“ <em>writing logs to Amazon CloudWatch and writing items to a DynamoDB table</em>.</p>
<p>Detailed steps are <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/3_ServerlessBackend" target="_blank" rel="external">available here</a> for creating the IAM role.</p>
<p>Now that we have the DynamoDB database created and a role ready to associate with our Lambda function we can create the function itself!</p>
<p>Create a Lambda function called <code>RequestUnicorn</code>. The Amazon Web Services team provided the Node.js script for the Lambda function <a href="https://github.com/awslabs/aws-serverless-workshops/blob/master/WebApplication/3_ServerlessBackend/requestUnicorn.js" target="_blank" rel="external">here</a>. The full code for our Lambda function is below:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> randomBytes = <span class="built_in">require</span>(<span class="string">'crypto'</span>).randomBytes;</div><div class="line"></div><div class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> ddb = <span class="keyword">new</span> AWS.DynamoDB.DocumentClient();</div><div class="line"></div><div class="line"><span class="keyword">const</span> fleet = [</div><div class="line">    &#123;</div><div class="line">        <span class="attr">Name</span>: <span class="string">'Bucephalus'</span>,</div><div class="line">        <span class="attr">Color</span>: <span class="string">'Golden'</span>,</div><div class="line">        <span class="attr">Gender</span>: <span class="string">'Male'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="attr">Name</span>: <span class="string">'Shadowfax'</span>,</div><div class="line">        <span class="attr">Color</span>: <span class="string">'White'</span>,</div><div class="line">        <span class="attr">Gender</span>: <span class="string">'Male'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="attr">Name</span>: <span class="string">'Rocinante'</span>,</div><div class="line">        <span class="attr">Color</span>: <span class="string">'Yellow'</span>,</div><div class="line">        <span class="attr">Gender</span>: <span class="string">'Female'</span>,</div><div class="line">    &#125;,</div><div class="line">];</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!event.requestContext.authorizer) &#123;</div><div class="line">      errorResponse(<span class="string">'Authorization not configured'</span>, context.awsRequestId, callback);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> rideId = toUrlString(randomBytes(<span class="number">16</span>));</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Received event ('</span>, rideId, <span class="string">'): '</span>, event);</div><div class="line"></div><div class="line">    <span class="comment">// Because we're using a Cognito User Pools authorizer, all of the claims</span></div><div class="line">    <span class="comment">// included in the authentication token are provided in the request context.</span></div><div class="line">    <span class="comment">// This includes the username as well as other attributes.</span></div><div class="line">    <span class="keyword">const</span> username = event.requestContext.authorizer.claims[<span class="string">'cognito:username'</span>];</div><div class="line"></div><div class="line">    <span class="comment">// The body field of the event in a proxy integration is a raw string.</span></div><div class="line">    <span class="comment">// In order to extract meaningful values, we need to first parse this string</span></div><div class="line">    <span class="comment">// into an object. A more robust implementation might inspect the Content-Type</span></div><div class="line">    <span class="comment">// header first and use a different parsing strategy based on that value.</span></div><div class="line">    <span class="keyword">const</span> requestBody = <span class="built_in">JSON</span>.parse(event.body);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> pickupLocation = requestBody.PickupLocation;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> unicorn = findUnicorn(pickupLocation);</div><div class="line"></div><div class="line">    recordRide(rideId, username, unicorn).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        <span class="comment">// You can use the callback function to provide a return value from your Node.js</span></div><div class="line">        <span class="comment">// Lambda functions. The first parameter is used for failed invocations. The</span></div><div class="line">        <span class="comment">// second parameter specifies the result data of the invocation.</span></div><div class="line"></div><div class="line">        <span class="comment">// Because this Lambda function is called by an API Gateway proxy integration</span></div><div class="line">        <span class="comment">// the result object must use the following structure.</span></div><div class="line">        callback(<span class="literal">null</span>, &#123;</div><div class="line">            <span class="attr">statusCode</span>: <span class="number">201</span>,</div><div class="line">            <span class="attr">body</span>: <span class="built_in">JSON</span>.stringify(&#123;</div><div class="line">                <span class="attr">RideId</span>: rideId,</div><div class="line">                <span class="attr">Unicorn</span>: unicorn,</div><div class="line">                <span class="attr">Eta</span>: <span class="string">'30 seconds'</span>,</div><div class="line">                <span class="attr">Rider</span>: username,</div><div class="line">            &#125;),</div><div class="line">            <span class="attr">headers</span>: &#123;</div><div class="line">                <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span>,</div><div class="line">            &#125;,</div><div class="line">        &#125;);</div><div class="line">    &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.error(err);</div><div class="line"></div><div class="line">        <span class="comment">// If there is an error during processing, catch it and return</span></div><div class="line">        <span class="comment">// from the Lambda function successfully. Specify a 500 HTTP status</span></div><div class="line">        <span class="comment">// code and provide an error message in the body. This will provide a</span></div><div class="line">        <span class="comment">// more meaningful error response to the end client.</span></div><div class="line">        errorResponse(err.message, context.awsRequestId, callback)</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// This is where you would implement logic to find the optimal unicorn for</span></div><div class="line"><span class="comment">// this ride (possibly invoking another Lambda function as a microservice.)</span></div><div class="line"><span class="comment">// For simplicity, we'll just pick a unicorn at random.</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">findUnicorn</span>(<span class="params">pickupLocation</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Finding unicorn for '</span>, pickupLocation.Latitude, <span class="string">', '</span>, pickupLocation.Longitude);</div><div class="line">    <span class="keyword">return</span> fleet[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * fleet.length)];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">recordRide</span>(<span class="params">rideId, username, unicorn</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> ddb.put(&#123;</div><div class="line">        <span class="attr">TableName</span>: <span class="string">'Rides'</span>,</div><div class="line">        <span class="attr">Item</span>: &#123;</div><div class="line">            <span class="attr">RideId</span>: rideId,</div><div class="line">            <span class="attr">User</span>: username,</div><div class="line">            <span class="attr">Unicorn</span>: unicorn,</div><div class="line">            <span class="attr">RequestTime</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(),</div><div class="line">        &#125;,</div><div class="line">    &#125;).promise();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">toUrlString</span>(<span class="params">buffer</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> buffer.toString(<span class="string">'base64'</span>)</div><div class="line">        .replace(<span class="regexp">/\+/g</span>, <span class="string">'-'</span>)</div><div class="line">        .replace(<span class="regexp">/\//g</span>, <span class="string">'_'</span>)</div><div class="line">        .replace(<span class="regexp">/=/g</span>, <span class="string">''</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">errorResponse</span>(<span class="params">errorMessage, awsRequestId, callback</span>) </span>&#123;</div><div class="line">  callback(<span class="literal">null</span>, &#123;</div><div class="line">    <span class="attr">statusCode</span>: <span class="number">500</span>,</div><div class="line">    <span class="attr">body</span>: <span class="built_in">JSON</span>.stringify(&#123;</div><div class="line">      <span class="attr">Error</span>: errorMessage,</div><div class="line">      <span class="attr">Reference</span>: awsRequestId,</div><div class="line">    &#125;),</div><div class="line">    <span class="attr">headers</span>: &#123;</div><div class="line">      <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Currently we can write Lambda functions in Node.js, Python, Java or C#. The above code is a Node.js function that checks the user is authorized, writes to DynamoDB within the <code>recordRide</code> function and sends a random Unicorn back to the user. After reviewing the code, paste in the Lambda function and create it, leaving the default <code>index.handler</code>.</p>
<p>We can also configure a test event to make sure our Lambda function is envoked properly. If you would like to test your Lambda function, paste in the sample <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/3_ServerlessBackend" target="_blank" rel="external">event code</a> and verify that the execute succeeds.</p>
<h2 id="Step-5-Setup-API-Gateway"><a href="#Step-5-Setup-API-Gateway" class="headerlink" title="Step 5: Setup API Gateway"></a>Step 5: Setup API Gateway</h2><p>We have set everything up for our Lambda function and static website. Now we need to set up API Gateway so that our static website can trigger the Lambda function. Amazonâ€™s <a href="https://aws.amazon.com/api-gateway/" target="_blank" rel="external">API Gateway</a> allows us to create RESTful APIs that expose HTTP endpoints. These endpoints can be invoked from the browser.</p>
<p>The final step is to <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/4_RESTfulAPIs" target="_blank" rel="external">create an API Gateway</a> that will be our REST API. We could use tools like <a href="https://swagger.io/" target="_blank" rel="external">Swagger</a> or <a href="http://stoplight.io/" target="_blank" rel="external">stoplight.io</a> at this point. Since we are only creating one HTTP endpoint we will create it manually.</p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/create-api.png" alt=""></p>
<p>After creating the API Gateway, we hook up Cognito to our endpoints. Doing this allows API Gateway to use and test the JWT tokens returned by Cognito. If you are not familiar with JWT, you can check out a sample applications <a href="https://github.com/connor11528/vuejs-auth-frontend" target="_blank" rel="external">here</a> and <a href="http://connorleech.info/blog/use-express-angular-and-jwt-to-make-a-secure-app/">here</a> utilizing client side Javascript.</p>
<p>In order to hook up Cognito to API Gateway and protect our endpoints create a Cognito User pool authorizer:</p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/create-user-pool-authorizer.png" alt=""></p>
<p>Select Authorizers. Create -&gt; Cognito user pool.</p>
<p>Now that that is configured we create a new <strong>resource method</strong> for the <code>POST /ride</code> endpoint.</p>
<p><img src="https://github.com/awslabs/aws-serverless-workshops/raw/master/WebApplication/images/api-integration-setup.png" alt=""></p>
<p>More detailed instructions are available <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication/4_RESTfulAPIs" target="_blank" rel="external">here</a> but the gist is that we select the option for Proxy Integration and add the WildRydesLambda function tat we created in the last step. Select method request card and under authorization select our Cognito user pool.</p>
<p>We also have to enable CORS for our endpoint. In the API Gateway console, under <strong>Actions</strong> and replace default values and select <strong>Enable CORS</strong>. Everything can be left as the defaults.</p>
<p>Deploy the API Gateway by selecting <strong>Actions -&gt; Deploy</strong>. This generates an <strong>Invoke URL</strong> that we must include in <strong>js/cofig.js</strong>. In my case the value is <code>https://tfyxh265h2.execute-api.us-west-2.amazonaws.com/prod</code>. This endpoint is what our website requests via AJAX that invokes the Lambda function.</p>
<p>Everything should work now. The demo application is <a href="http://wildrydes-082317.s3-website-us-west-2.amazonaws.com/" target="_blank" rel="external">available here</a>. If you have any questions about Node.js or serverless Iâ€™m available <a href="https://twitter.com/Connor11528" target="_blank" rel="external">on twitter</a> and the full source code from the AWS team is <a href="https://github.com/awslabs/aws-serverless-workshops/tree/master/WebApplication" target="_blank" rel="external">here</a></p>
<p>Thanks for reading! If you enjoyed please share/upvote so that more people can hop on the serverless bandwagon and drink the Kool Aid.</p>
<p><img src="https://media3.giphy.com/media/VxoZWcyfgbzhe/giphy.gif" alt="Serverless Kool Aid"></p>
</div><div id="disqus_thread"></div></article><nav class="pagination"><a href="/blog/Deploy-a-Laravel-5-app-to-Heroku/" title="Deploy a Laravel 5 app to Heroku" class="btn-default entry-pagination__link entry-pagination__link--prev">Prev</a><a href="/blog/How-to-Build-Payment-Processing-with-Vuejs-and-Nodejs/" title="How to process payments with Node.js, Vue 2 and Stripe" class="btn-default entry-pagination__link entry-pagination__link--next">Next</a></nav></div></div></div></main><footer class="footer"><div class="container"><div class="row"><div class="col-sm-6"><h4>Connor11528 dev newsletter</h4><ul><li><form action="//herokuapp.us14.list-manage.com/subscribe/post?u=42dd73a709fbadb4a29ef1d0d&amp;amp;id=b77fdad58d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate class="validate"><div class="input-group"><input type="email" value="" name="EMAIL" id="mce-EMAIL" placeholder="Enter your email here" class="required email form-control input-lg"><div id="mce-error-response" style="display:none" class="response"></div><div id="mce-success-response" style="display:none" class="response"></div><div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_42dd73a709fbadb4a29ef1d0d_b77fdad58d" tabindex="-1" value=""></div><span class="input-group-btn"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-primary btn-lg"></span></div></form></li></ul></div><div class="col-sm-2 col-sm-offset-1"><h4>Connect</h4><ul><li> <a target="_blank" href="https://github.com/connor11528">GitHub</a></li><li> <a target="_blank" href="https://www.linkedin.com/in/connorleech">LinkedIn</a></li><li> <a target="_blank" href="https://twitter.com/connor11528">Twitter</a></li><li><a target="_blank" href="https://medium.com/@connorleech">Medium</a></li><li><a target="_blank" href="https://stackoverflow.com/users/2031033/connor-leech">Stackoverflow</a></li><li><a target="_blank" href="https://plus.google.com/u/0/+ConnorLeech">Google+</a></li></ul></div><div class="col-sm-3"><h4>Email</h4><ul><li> <a href="mailto:connorleech@gmail.com">connorleech@gmail.com</a></li></ul></div></div></div></footer><!-- vendor--><script src="/bower_components/jquery/dist/jquery.min.js"></script><script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/bower_components/wow/dist/wow.min.js"></script><script src="/bower_components/jquery-easing/jquery.easing.min.js"></script><script src="/bower_components/jquery-color/jquery.color.js"></script><script src="/bower_components/scrollmagic/scrollmagic/minified/ScrollMagic.min.js"></script><script src="/bower_components/scrollmagic/scrollmagic/minified/plugins/debug.addIndicators.min.js"></script><script src="/bower_components/vivus/dist/vivus.min.js"></script><!-- require modules--><script src="/js/require.js"></script><script src="/js/app.js"></script><!-- analytics--><!-- disqus--><script>(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://connorleech.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></body></html>